<div *ngIf="loading" class="flex flex-col items-center justify-center py-10 text-green-400">
  <div class="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
  <p class="mt-3 text-lg font-medium">Cargando cotizaciones...</p>
</div>

<!-- Sección ADMIN -->
<ng-container *ngIf="authService.getUserDetail()?.roles.includes('Admin'); else checkLogin">
  <section class=" p-6  min-h-screen flex flex-col">
    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">Todas las Cotizaciones</h2>
    
    <div class="overflow-x-auto bg-gray-900 rounded-lg shadow">
      <table class="min-w-full text-sm text-left text-green-500">
        <thead class="bg-black text-green-400 uppercase text-xs font-semibold">
          <tr>
            <th class="px-4 py-3">ID</th>
            <th class="px-4 py-3">Usuario</th>
            <th class="px-4 py-3">Fecha</th>
            <th class="px-4 py-3">Total</th>
            <th class="px-4 py-3">Estatus</th>
            <th class="px-4 py-3">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let q of quotations" class="border-b hover:bg-gray-700">
            <td class="px-4 py-3">{{ q.id }}</td>
            <td class="px-4 py-3">{{ q.user?.fullName || '—' }}</td>
            <td class="px-4 py-3">{{ q.date | date: 'short' }}</td>
            <td class="px-4 py-3">{{ q.total | currency }}</td>
            <td class="px-4 py-3">
              <span class="px-2 py-1 rounded-full text-white text-xs"
                [ngClass]="{
                  'bg-blue-500': q.status === 0,
                  'bg-green-500': q.status === 1,
                  'bg-yellow-500 text-black': q.status === 4,
                  'bg-red-500': q.status === 3,
                  'bg-teal-500': q.status === 2
                }">
                {{ getStatusName(q.status) }}
              </span>
            </td>
            <td class="px-4 py-3 space-x-2">
              <button *ngIf="q.status === 0" (click)="acceptQuotation(q.id)" 
                class="px-3 py-1 text-xs font-medium text-white bg-green-600 rounded hover:bg-green-700">Aceptar</button>
              <button *ngIf="q.status === 0" (click)="rejectQuotation(q.id)" 
                class="px-3 py-1 text-xs font-medium text-white bg-red-600 rounded hover:bg-red-700">Rechazar</button>
              <button (click)="verDetalle(q.id)" 
                class="px-3 py-1 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700">Detalles</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
</ng-container>

<!-- Sección USUARIO -->
<ng-template #checkLogin> 
  <section class="p-6  min-h-screen flex flex-col">
    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">Mis Cotizaciones</h2>

    <div class="overflow-x-auto bg-gray-900 rounded-lg shadow">
      <table class="min-w-full text-sm text-left text-green-500">
        <thead class="bg-black text-green-400 uppercase text-xs font-semibold">
          <tr>
            <th class="px-4 py-3">ID</th>
            <th class="px-4 py-3">Fecha</th>
            <th class="px-4 py-3">Total</th>
            <th class="px-4 py-3">Estatus</th>
            <th class="px-4 py-3">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let q of myQuotations" class="border-b hover:bg-gray-50">
            <td class="px-4 py-3">{{ q.id }}</td>
            <td class="px-4 py-3">{{ q.date | date: 'short' }}</td>
            <td class="px-4 py-3">{{ q.total | currency }}</td>
            <td class="px-4 py-3">
              <span class="px-2 py-1 rounded-full text-white text-xs"
                [ngClass]="{
                  'bg-blue-500': q.status === 0,
                  'bg-green-500': q.status === 1,
                  'bg-yellow-500 text-black': q.status === 4,
                  'bg-red-500': q.status === 3,
                  'bg-teal-500': q.status === 2
                }">
                {{ getStatusName(q.status) }}
              </span>
            </td>
            <td class="px-4 py-3 space-x-2">
              <button *ngIf="q.status === 1" (click)="payQuotation(q.id)" 
                class="px-3 py-1 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700">Pagar</button>
              <button *ngIf="q.status === 1" (click)="cancelQuotation(q.id)" 
                class="px-3 py-1 text-xs font-medium text-white bg-yellow-500 rounded hover:bg-yellow-600 text-black">Cancelar</button>
              <button (click)="verDetalle(q.id)" 
                class="px-3 py-1 text-xs font-medium text-white bg-indigo-600 rounded hover:bg-indigo-700">Detalles</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
</ng-template>


<!-- Modal de detalles -->
<div *ngIf="showModal && detalleSeleccionado" class="fixed inset-0 text-green-400 bg-opacity-50 flex items-center justify-center p-4 z-50">
  <div class="bg-gray-900 rounded-lg shadow-lg w-full max-w-2xl p-6 border border-green-400">
    
    <!-- Encabezado -->
    <h3 class="text-lg font-bold mb-4">Detalles de Cotización #{{ detalleSeleccionado.id }}</h3>

    <!-- Info general -->
    <div class="mb-4 text-sm text-green-500 space-y-1">
      <p><span class="font-semibold">Usuario:</span> {{ detalleSeleccionado.user?.fullName || '—' }}</p>
      <p><span class="font-semibold">Correo:</span> {{ detalleSeleccionado.user?.email || '—' }}</p>
      <p><span class="font-semibold">Fecha:</span> {{ detalleSeleccionado.date | date: 'fullDate' }}</p>
      <p>
        <span class="font-semibold">Estatus:</span>
        <span class="px-2 py-1 rounded-full text-white text-xs"
          [ngClass]="{
            'bg-blue-500': detalleSeleccionado.status === 0,
            'bg-green-500': detalleSeleccionado.status === 1,
            'bg-yellow-500 text-black': detalleSeleccionado.status === 4,
            'bg-red-500': detalleSeleccionado.status === 3,
            'bg-teal-500': detalleSeleccionado.status === 2
          }">
          {{ getStatusName(detalleSeleccionado.status) }}
        </span>
      </p>
    </div>

    <!-- Lista de productos -->
    <div class="overflow-x-auto mb-6">
      <table class="min-w-full text-sm text-left text-green-500 border border-green-400 rounded-lg">
        <thead class="bg-black text-green-400 uppercase text-xs font-semibold">
          <tr>
            <th class="px-4 py-2">Producto</th>
            <th class="px-4 py-2 text-center">Cantidad</th>
            <th class="px-4 py-2 text-right">Precio Unitario</th>
            <th class="px-4 py-2 text-right">Subtotal</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of cotizacionPreview.detalles" class="border-b hover:bg-gray-300">
            <td class="px-4 py-2">{{ item.nombre }}</td>
            <td class="px-4 py-2 text-center">{{ item.cantidad }}</td>
            <td class="px-4 py-2 text-right">{{ item.precio | currency }}</td>
            <td class="px-4 py-2 text-right">{{ (item.precio * item.cantidad) | currency }}</td>
          </tr>
          <tr *ngIf="cotizacionPreview.detalles.length === 0">
            <td colspan="4" class="px-4 py-2 text-center text-gray-500">No hay productos</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Totales -->
    <div class="border-t border-green-600 pt-4 space-y-1 text-sm">
      <div class="flex justify-between">
        <span>Subtotal:</span>
        <span>{{ cotizacionPreview.subtotal | currency }}</span>
      </div>
      <div class="flex justify-between">
        <span>Coste de la aplicación:</span>
        <span>{{ cotizacionPreview.extraSensores | currency }}</span>
      </div>
      <div class="flex justify-between">
        <span>Envío e instalación:</span>
        <span>{{ cotizacionPreview.extraPorcentaje | currency }}</span>
      </div>
      <div class="flex justify-between font-bold text-green-600 text-base">
        <span>Total Final:</span>
        <span>{{ cotizacionPreview.totalFinal | currency }}</span>
      </div>
    </div>

    <!-- Acciones -->
    <div class="mt-6 flex justify-end">
      <button class="px-4 py-2 text-sm font-medium text-white bg-gray-600 rounded hover:bg-gray-700"
        (click)="cerrarDetalle()">Cerrar</button>
    </div>
  </div>
</div>